<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edugana - Historial de Asistencias (Bulma)</title>
    <script src="js/historial.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css">
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
    <style>
        /* Estilo personalizado para asegurar el color azul profundo/brillante en botón */
        .button.is-primary {
            background-color: #3273dc !important;
            color: #fff !important;
        }

        /* Estilos generales */
        body {
            padding-top: 0; 
            margin: 0;
        }
        .page-container {
            margin-top: 0;
            margin-bottom: 3rem;
        }
        .section {
            padding: 0;
        }
        .table-container {
            overflow-x: auto;
        }
        .card-row {
            margin-bottom: 1rem;
        }
        /* Clase para asegurar mayúsculas */
        .is-uppercase-text {
            text-transform: uppercase;
        }
        /* CLASES DE RESPONSIVIDAD DE BULMA */
        @media screen and (max-width: 1023px) {
            .is-hidden-desktop { display: inherit !important; }
            .is-hidden-touch { display: none !important; }
        }

        /* ESTILOS DEL HEADER */
        .page-header {
            margin-bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 0px 0px 12px 12px;
            padding: 1rem 2rem;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .page-header .title,
        .page-header .subtitle {
            color: white !important;
            margin-bottom: 0 !important;
        }

        .page-header .title.is-2 {
            font-size: 1.5rem;
        }

        .page-header .icon {
            color: white;
        }

        .page-header .icon-text {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .page-header .icon-text .icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Icono de moneda */
        .coin-icon {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }

        /* EduGana badge - SIN BORDE */
        .edugana-badge {
            display: inline-block;
            font-size: 0.7rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 1);
            background: transparent;
            padding: 0.2rem 0.6rem;
            border-radius: 20px;
            margin-top: 0.25rem;
        }

        /* Contenedor del contenido */
        .content-wrapper {
            padding: 2rem 1.5rem;
        }

        /* Estilos para tarjetas móvil simplificadas */
        .mobile-card {
            border: 1px solid #dbdbdb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: white;
        }

        .mobile-card-date {
            font-size: 1.1rem;
            font-weight: bold;
            color: #363636;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #f5f5f5;
        }

        .mobile-card-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            padding: 0.25rem 0;
        }

        .mobile-card-label {
            font-weight: 600;
            color: #7a7a7a;
            font-size: 0.875rem;
        }

        .mobile-card-value {
            color: #363636;
            font-size: 0.875rem;
            text-align: right;
        }

        /* Indicador de carga */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3273dc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Media Queries específicas para el encabezado */
        @media screen and (max-width: 768px) {
            .page-header .level {
                display: block !important;
                text-align: center;
            }

            .page-header .level-left,
            .page-header .level-right {
                margin-bottom: 0.5rem;
                text-align: center;
            }

            .page-header .level-item {
                display: block;
                margin-bottom: 0;
            }

            .page-header .title.is-2 {
                font-size: 1.15rem;
            }

            .page-header .subtitle.is-5 {
                font-size: 0.95rem;
            }

            .page-header {
                padding: 0.75rem 1rem;
            }

            .page-header .icon-text {
                display: flex;
                justify-content: center;
                flex-wrap: wrap;
            }

            .coin-icon {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
                margin: 0 auto;
            }

            .content-wrapper {
                padding: 1.5rem 1rem;
            }
        }

        /* Pantallas muy pequeñas */
        @media screen and (max-width: 480px) {
            .page-header .title.is-2 {
                font-size: 1rem;
            }

            .page-header .subtitle.is-5 {
                font-size: 0.85rem;
            }

            .coin-icon {
                width: 38px;
                height: 38px;
                font-size: 1.1rem;
            }

            .page-header {
                padding: 0.65rem 0.875rem;
            }
        }

        /* Tablet */
        @media screen and (min-width: 769px) and (max-width: 1023px) {
            .page-header {
                padding: 1rem 1.5rem;
            }
        }
    </style>
</head>
<body>

    <section class="section">
        <!-- HEADER -->
        <div class="page-header">
            <div class="container">
                <div class="level">
                    <div class="level-left">
                        <div class="level-item">
                            <div>
                                <h1 class="title is-2">
                                    <span class="icon-text">
                                        <span class="icon has-text-white mr-2">
                                            <i class="fas fa-calendar-check"></i>
                                        </span>
                                        <span>Historial de Asistencias</span>
                                    </span>
                                </h1>
                                <span class="edugana-badge">EduGana</span>
                            </div>
                        </div>
                    </div>
                    <div class="level-right">
                        <div class="level-item">
                            <div class="coin-icon" aria-hidden="true">
                                <i class="fas fa-coins"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container page-container">
            <div class="box">
                <div class="content-wrapper">
                    <!-- FILTROS DESKTOP -->
                    <div class="is-hidden-touch mb-5">
                        <form id="filtrosDesktop">
                            <div class="columns is-vcentered">
                                <div class="column is-3">
                                    <a href="inicio.html" class="button is-light is-small mb-2" title="Ir al inicio" aria-label="Ir al inicio">
                                        <span class="icon"><i class="fas fa-home"></i></span>
                                        <span>Inicio</span>
                                    </a>
                                    <label class="label is-size-7">Inicio (Fecha)</label>
                                    <div class="control">
                                        <input class="input is-small" type="date" id="fechaInicioDesktop" placeholder="dd/mm/aaaa">
                                    </div>
                                </div>
                                <div class="column is-3">
                                    <label class="label is-size-7">Fin (Fecha)</label>
                                    <div class="control">
                                        <input class="input is-small" type="date" id="fechaFinDesktop" placeholder="dd/mm/aaaa">
                                    </div>
                                </div>
                                <div class="column is-3">
                                    <label class="label is-size-7">Colegio (Filtro)</label>
                                    <div class="control">
                                        <input class="input is-small" type="text" id="colegioDesktop" placeholder="Buscar Colegio...">
                                    </div>
                                </div>
                                <div class="column is-3">
                                    <label class="label is-size-7 has-text-white-ter">Buscar</label>
                                    <div class="control">
                                        <button type="submit" class="button is-primary is-small is-fullwidth">
                                            <i class="fas fa-search mr-1"></i> Buscar
                                        </button>
                                        <button type="button" onclick="limpiarFiltros()" class="button is-light is-small is-fullwidth mt-2">
                                            <i class="fas fa-times mr-1"></i> Limpiar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- FILTROS MÓVIL -->
                    <div class="is-hidden-desktop mb-5">
                        <a href="inicio.html" class="button is-light is-small mb-3" title="Ir al inicio" aria-label="Ir al inicio">
                            <span class="icon"><i class="fas fa-home"></i></span>
                            <span>Inicio</span>
                        </a>
                        <form id="filtrosMovil">
                            <div class="field">
                                <label class="label is-size-7">Inicio (Fecha)</label>
                                <div class="control">
                                    <input class="input is-small" type="date" id="fechaInicioMovil">
                                </div>
                            </div>
                            <div class="field">
                                <label class="label is-size-7">Fin (Fecha)</label>
                                <div class="control">
                                    <input class="input is-small" type="date" id="fechaFinMovil">
                                </div>
                            </div>
                            <div class="field">
                                <label class="label is-size-7">Colegio (Filtro)</label>
                                <div class="control">
                                    <input class="input is-small" type="text" id="colegioMovil" placeholder="Buscar Colegio...">
                                </div>
                            </div>
                            <div class="field">
                                <div class="control">
                                    <button type="submit" class="button is-primary is-small is-fullwidth">
                                        <i class="fas fa-search mr-1"></i> Buscar
                                    </button>
                                    <button type="button" onclick="limpiarFiltros()" class="button is-light is-small is-fullwidth mt-2">
                                        <i class="fas fa-times mr-1"></i> Limpiar
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- TABLA DESKTOP -->
                    <div class="is-hidden-touch">
                        <div class="table-container">
                            <table class="table is-striped is-hoverable is-fullwidth">
                                <thead>
                                    <tr>
                                        <th><abbr title="Identificador de Registro">ID.Reg.</abbr></th>
                                        <th>Nombres</th>
                                        <th>Fecha</th>
                                        <th>Hora de Registro</th>
                                        <th>Tipo de Movimiento</th>
                                        <th>Colegio</th> 
                                    </tr>
                                </thead>
                                <tbody id="tablaAsistenciasDesktop">
                                    <tr>
                                        <td colspan="6" class="has-text-centered">
                                            <div class="loading-spinner">
                                                <div class="spinner"></div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="6"> 
                                            <p class="has-text-right is-size-7" id="fechaActualizacion">Cargando datos...</p>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <!-- PAGINACIÓN -->
                        <nav class="pagination is-centered" role="navigation" aria-label="pagination" id="paginacionDesktop" style="display: none;">
                            <a class="pagination-previous" id="btnAnterior">Anterior</a>
                            <a class="pagination-next" id="btnSiguiente">Siguiente</a>
                            <ul class="pagination-list" id="listaPaginas">
                            </ul>
                        </nav>
                    </div>

                    <hr>

                    <!-- TARJETAS MÓVIL -->
                    <div class="is-hidden-desktop">
                        <h2 class="title is-5">Resumen de Registros</h2>
                        <div id="tarjetasAsistenciasMovil">
                            <div class="loading-spinner">
                                <div class="spinner"></div>
                            </div>
                        </div>
                        
                        <div class="has-text-centered mt-4" id="btnCargarMas" style="display: none;">
                            <button class="button is-info is-outlined is-fullwidth is-small" onclick="cargarMasRegistros()">
                                Cargar Más Registros
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        // ========================================
        // CONFIGURACIÓN DE LA API
        // ========================================
        const API_URL = 'http://localhost:5000';
        let asistenciasGlobales = [];
        let asistenciasFiltradas = [];
        let paginaActual = 1;
        const registrosPorPagina = 10;

        // ========================================
        // FUNCIÓN PRINCIPAL: CARGAR ASISTENCIAS
        // ========================================
        async function cargarAsistencias() {
            try {
                mostrarCargando(true);
                
                const response = await fetch(`${API_URL}/asistencias`);
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                asistenciasGlobales = data.data || data;
                asistenciasFiltradas = [...asistenciasGlobales];
                
                mostrarAsistencias();
                actualizarFechaActualizacion();
                
            } catch (error) {
                console.error('Error al cargar asistencias:', error);
                mostrarError(`No se pudieron cargar las asistencias. ${error.message}`);
            } finally {
                mostrarCargando(false);
            }
        }

        // ========================================
        // MOSTRAR ASISTENCIAS EN TABLA Y TARJETAS
        // ========================================
        function mostrarAsistencias() {
            const inicio = (paginaActual - 1) * registrosPorPagina;
            const fin = inicio + registrosPorPagina;
            const asistenciasPagina = asistenciasFiltradas.slice(inicio, fin);

            // TABLA DESKTOP
            const tbodyDesktop = document.getElementById('tablaAsistenciasDesktop');
            tbodyDesktop.innerHTML = '';
            
            if (asistenciasPagina.length === 0) {
                tbodyDesktop.innerHTML = '<tr><td colspan="6" class="has-text-centered">No hay registros de asistencia</td></tr>';
            } else {
                asistenciasPagina.forEach(asistencia => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${asistencia.id || '---'}</td>
                        <td>${asistencia.nombre_estudiante || 'Sin nombre'}</td>
                        <td>${formatearFecha(asistencia.fecha)}</td>
                        <td>${asistencia.hora_entrada || '---'}</td>
                        <td>${getTagEstado(asistencia.asistencia)}</td>
                        <td><strong>${asistencia.colegio || 'Sin especificar'}</strong></td>
                    `;
                    tbodyDesktop.appendChild(tr);
                });
            }

            // TARJETAS MÓVIL
            const contenedorMovil = document.getElementById('tarjetasAsistenciasMovil');
            contenedorMovil.innerHTML = '';
            
            if (asistenciasPagina.length === 0) {
                contenedorMovil.innerHTML = '<p class="has-text-centered has-text-grey">No hay registros para mostrar</p>';
            } else {
                asistenciasPagina.forEach(asistencia => {
                    const card = crearTarjetaMovil(asistencia);
                    contenedorMovil.insertAdjacentHTML('beforeend', card);
                });
            }

            // PAGINACIÓN
            mostrarPaginacion();
        }

        // ========================================
        // CREAR TARJETA MÓVIL
        // ========================================
        function crearTarjetaMovil(asistencia) {
            return `
                <div class="mobile-card">
                    <div class="mobile-card-date">
                        <i class="fas fa-calendar-alt"></i> ${formatearFecha(asistencia.fecha)}
                    </div>
                    <div class="mobile-card-row">
                        <span class="mobile-card-label">Nombres:</span>
                        <span class="mobile-card-value">${asistencia.nombre_estudiante || 'Sin nombre'}</span>
                    </div>
                    <div class="mobile-card-row">
                        <span class="mobile-card-label">ID.Reg:</span>
                        <span class="mobile-card-value">${asistencia.estudiante_id || '---'}</span>
                    </div>
                    <div class="mobile-card-row">
                        <span class="mobile-card-label">Movimiento:</span>
                        <span class="mobile-card-value">${getTagEstado(asistencia.asistencia)}</span>
                    </div>
                    <div class="mobile-card-row">
                        <span class="mobile-card-label">Hora:</span>
                        <span class="mobile-card-value">${asistencia.hora_entrada || '---'}</span>
                    </div>
                    <div class="mobile-card-row">
                        <span class="mobile-card-label">Colegio:</span>
                        <span class="mobile-card-value">${asistencia.colegio || 'Sin especificar'}</span>
                    </div>
                </div>
            `;
        }

        // ========================================
        // FORMATEAR FECHA
        // ========================================
        function formatearFecha(fecha) {
            if (!fecha) return '---';
            const date = new Date(fecha + 'T00:00:00');
            const opciones = { year: 'numeric', month: '2-digit', day: '2-digit' };
            return date.toLocaleDateString('es-PE', opciones);
        }

        // ========================================
        // OBTENER TAG DE ESTADO
        // ========================================
        function getTagEstado(estado) {
            const estados = {
                'Entrada': '<span class="tag is-success is-light">Entrada</span>',
                'Salida': '<span class="tag is-info is-light">Salida</span>',
                'Ausente': '<span class="tag is-danger is-light">Ausente</span>',
                'Presente': '<span class="tag is-success is-light">Presente</span>'
            };
            return estados[estado] || '<span class="tag is-light">---</span>';
        }

        // ========================================
        // FILTRAR ASISTENCIAS
        // ========================================
        function aplicarFiltros(event) {
            event.preventDefault();
            
            const esMovil = window.innerWidth < 1024;
            const fechaInicio = document.getElementById(esMovil ? 'fechaInicioMovil' : 'fechaInicioDesktop').value;
            const fechaFin = document.getElementById(esMovil ? 'fechaFinMovil' : 'fechaFinDesktop').value;
            const colegio = document.getElementById(esMovil ? 'colegioMovil' : 'colegioDesktop').value.toLowerCase();

            asistenciasFiltradas = asistenciasGlobales.filter(asistencia => {
                let cumpleFecha = true;
                let cumpleColegio = true;

                // Filtro por fecha de inicio
                if (fechaInicio && asistencia.fecha) {
                    cumpleFecha = asistencia.fecha >= fechaInicio;
                }

                // Filtro por fecha fin
                if (fechaFin && asistencia.fecha && cumpleFecha) {
                    cumpleFecha = asistencia.fecha <= fechaFin;
                }

                // Filtro por colegio
                if (colegio && asistencia.colegio) {
                    cumpleColegio = asistencia.colegio.toLowerCase().includes(colegio);
                }

                return cumpleFecha && cumpleColegio;
            });

            paginaActual = 1;
            mostrarAsistencias();
        }

        // ========================================
        // LIMPIAR FILTROS
        // ========================================
        function limpiarFiltros() {
            // Desktop
            document.getElementById('fechaInicioDesktop').value = '';
            document.getElementById('fechaFinDesktop').value = '';
            document.getElementById('colegioDesktop').value = '';
            
            // Móvil
            document.getElementById('fechaInicioMovil').value = '';
            document.getElementById('fechaFinMovil').value = '';
            document.getElementById('colegioMovil').value = '';

            asistenciasFiltradas = [...asistenciasGlobales];
            paginaActual = 1;
            mostrarAsistencias();
        }

        // ========================================
        // PAGINACIÓN
        // ========================================
        function mostrarPaginacion() {
            const totalPaginas = Math.ceil(asistenciasFiltradas.length / registrosPorPagina);
            const paginacionDesktop = document.getElementById('paginacionDesktop');
            
            if (totalPaginas <= 1) {
                paginacionDesktop.style.display = 'none';
                return;
            }

            paginacionDesktop.style.display = 'flex';

            const btnAnterior = document.getElementById('btnAnterior');
            const btnSiguiente = document.getElementById('btnSiguiente');
            const listaPaginas = document.getElementById('listaPaginas');

            // Botón anterior
            if (paginaActual === 1) {
                btnAnterior.setAttribute('disabled', 'disabled');
            } else {
                btnAnterior.removeAttribute('disabled');
                btnAnterior.onclick = () => cambiarPagina(paginaActual - 1);
            }

            // Botón siguiente
            if (paginaActual === totalPaginas) {
                btnSiguiente.setAttribute('disabled', 'disabled');
            } else {
                btnSiguiente.removeAttribute('disabled');
                btnSiguiente.onclick = () => cambiarPagina(paginaActual + 1);
            }

            // Lista de páginas
            listaPaginas.innerHTML = '';
            for (let i = 1; i <= totalPaginas; i++) {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.classList.add('pagination-link');
                if (i === paginaActual) {
                    a.classList.add('is-current');
                }
                a.textContent = i;
                a.onclick = () => cambiarPagina(i);
                li.appendChild(a);
                listaPaginas.appendChild(li);
            }
        }

        function cambiarPagina(nuevaPagina) {
            paginaActual = nuevaPagina;
            mostrarAsistencias();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ========================================
        // MOSTRAR CARGANDO
        // ========================================
        function mostrarCargando(mostrar) {
            // Implementado en el HTML inicial
        }

        // ========================================
        // MOSTRAR ERROR
        // ========================================
        function mostrarError(mensaje) {
            const tbodyDesktop = document.getElementById('tablaAsistenciasDesktop');
            const contenedorMovil = document.getElementById('tarjetasAsistenciasMovil');
            
            const errorHTML = `
                <div class="notification is-danger is-light">
                    <span class="icon"><i class="fas fa-exclamation-triangle"></i></span>
                    <span>${mensaje}</span>
                </div>
            `;
            
            tbodyDesktop.innerHTML = `<tr><td colspan="6">${errorHTML}</td></tr>`;
            contenedorMovil.innerHTML = errorHTML;
        }

        // ========================================
        // ACTUALIZAR FECHA DE ACTUALIZACIÓN
        // ========================================
        function actualizarFechaActualizacion() {
            const ahora = new Date();
            const opciones = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            const fechaFormateada = ahora.toLocaleDateString('es-PE', opciones);
            document.getElementById('fechaActualizacion').textContent = 
                `Datos actualizados al ${fechaFormateada}`;
        }

        // ========================================
        // EVENTOS AL CARGAR LA PÁGINA
        // ========================================
        document.addEventListener('DOMContentLoaded', () => {
            // Cargar asistencias inicial
            cargarAsistencias();

            // Eventos de formularios
            document.getElementById('filtrosDesktop').addEventListener('submit', aplicarFiltros);
            document.getElementById('filtrosMovil').addEventListener('submit', aplicarFiltros);

            // Auto-actualización cada 30 segundos
            setInterval(cargarAsistencias, 30000);
        });
    </script>

</body>
</html>